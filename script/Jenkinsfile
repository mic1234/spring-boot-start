pipeline {
  agent {
    kubernetes {
      label 'podlabel'
      yaml """
kind: Pod
metadata:
  name: jenkins-agent
spec:
  containers:
  - name: maven
    image: gcr.io/cloud-builders/mvn
    imagePullPolicy: Always
    tty: true
    stdin: true
    command:
      - cat
  - name: jnlp
    image: 'jenkins/inbound-agent:4.3-4-alpine'
    args: ['\$(JENKINS_SECRET)', '\$(JENKINS_NAME)']
  - name: kaniko
    image: gcr.io/kaniko-project/executor:latest
    command:
      - /bin/bash
      - -c
      - while true; do date; sleep 1; done
    volumeMounts:
    - name: kaniko-secret
      mountPath: /secret
    env:
    - name: GOOGLE_APPLICATION_CREDENTIALS
      value: /secret/kaniko-secret.json
  restartPolicy: Never
  volumes:
  - name: kaniko-secret
    secret:
      secretName: kaniko-secret
---
apiVersion: v1
data:
  kaniko-secret.json: ewogICJ0eXBlIjogInNlcnZpY2VfYWNjb3VudCIsCiAgInByb2plY3RfaWQiOiAic29sYXItYm90YW55LTI5NzMwNiIsCiAgInByaXZhdGVfa2V5X2lkIjogImNjZTQzYTdhZWFjNGNjNjk2YWU0YzhhYzZlYjc0YzNmNzI5ZDFhYzgiLAogICJwcml2YXRlX2tleSI6ICItLS0tLUJFR0lOIFBSSVZBVEUgS0VZLS0tLS1cbk1JSUV2Z0lCQURBTkJna3Foa2lHOXcwQkFRRUZBQVNDQktnd2dnU2tBZ0VBQW9JQkFRREw0RlFJK2RTbkl2eHJcblZIUUR4WlBzbVg2QnBGV2FpaUZBSUhiZ1djRjRkTDdmUVpBQmhJY1B6ZjQwRU05UjJKMUJobVVhY2pjZWg0RXRcbjlBN2liT2s1NXFZcXYyaVdhMVBiVGNKUUtUa21ZNkJpQmI1eGJqa0VrWEYwUkVDWkNvdW5HS0dRWk9UWTI4UDZcbk16R3hORlIyZHV5bnRJekNXSzJFWDZQSkdjMGhNUUl3SHkzbDMzck1PN04rV3JadWFrU3VFYXEzbkcvV3VDTkxcbmkwYXR4SEpNcEtCdjlZcnQvZlVhUHkzUUUvbWN3OWowZllvZ0VqTkp6TGthcnFweDJJOEVBMVk4Z1lqRGIveGRcblp4VEpRTGg1Q3hlc0s4dSt5bnVsRDk4R3E4Y1VmYng1R2dWOVJTeGlqeUQyUmRsRUl3STFnVUdVMmRNMEM0Z3BcbjI3VEVPdDJwQWdNQkFBRUNnZ0VBQXdLeVF2cXJjdmRmaWxjeUtsOFh4dG5pWmhndTRtd1JQeURybUhjQzFoeEZcbk9FYy8wT0hyMjZZalQ1SUMrYmFzNWN1T0FTUzRIeVdKbVF2ZVQyWWowSVRSSmRielBLdGpqdHk0VnBZeFA1bWZcbmcrc0pTNlFBeUFvOHhtWituTFBzNllBQjNMKzhxRjRnWi9pckRtNlRJN2V3V1c2ZldIeFdQWnJxOEh5R3pLdGxcbm1WS1lUNnp6Smg3WXk4SGcwU2FuY3QzNFY0UGd2ZUpNUWVmRVQ2VHJVUzREeHpMVnpxOXVWbmdaaEdFVHBmVjNcbktKRmtWbFlaakpGZ3EyanNvczBKZDBKT1ZHSi93bHVlakk3L1RyMTNHdVYzb1JsanZweFVkd1lsam9FaEQ4bXJcbjNmY0l6eHBiZzNmV0huRU9iUjR3SkxxaStKN1NRM3BZR3cvWnV4Vnd3UUtCZ1FEbUlwa0tUU3hBVUhpQlNCblNcbnVFNUNobEdqNnUyS055QXNXYnNLU3k5ZE9lUktLNjUvQkh3VGh0ZFZqc1Z1enJQL2RweWF2R2xYS1FUL1F0cC9cblg2clR2YkVBSHU2VVhOSTBEUDg3ZUQzTFk0aFVPL1ozMFYzanI5c2lnNzlmTGhJRUlSTndZNllGUk91MkRFVTFcbnJ0MEFIQ29jSGQ4VE4zVHlsb2xRdGRPNUNRS0JnUURpeWpjMUROT01OSGp6ZlpDUFVYYUVrRUxxQ1NMMVN6S2Ncbm5weXBRMTkxZC9xY2NYdDgvbWlMMC9mQTJZVUhRZVYrV2habFBtQ2JaK1J1VHoxZmxrUWxaOWhkTlJpMEJuM01cbmYrQnh3WDlMOUgzTDg2emZBUzJkZkVrbWFvbVdCRUJMeUswSVJGMlZtb2xuaUt6QVh2SytkNUpaTGNKZWoxL2Vcbnp5Ny9uakpIb1FLQmdCTzk2QThBSzhtZ25aWEpqNTJKL2Z5cTlSbndyMHZxQ3JLRFNBNU1BTllvZnpMMXFGUnhcbkdBdTh4NEFwYlRwaU5RSzNOQnY2Q2JkV1ozMVdTTlFnYXRFYk5ySGg5V2w0eFBkK0hlOEdFNWI5Qk5ibEJmR2xcblhqNkgrVzV1aXQ0cFg1WkhHQm5PRXBIbEphdEtSaTJpd0lhZjQrVGhreDljNUlWaThJaWg4SFd4QW9HQkFMTldcbjkzdEREbEx6OTZXTTZQRDhtWDFRMnlsWldrU2hWMytVeWd2cjFDUC9ZYld1NDlrL0VZdHBicVVaSGVKVVVOZXZcbkE4RENLQUVja2Y1Tk9ScEtxTTd2cEtCb2FZV0xFSlhUbGJnL0xKdnkxanVmRVZnMEJVOWhSak5UMGtOSVQxUGVcbmVENXVXWmNCWXFEMTZxNGhKMUpKR2ZqZGY3UHBLd1gxenBPakZOMmhBb0dCQUllOFhDRUpiZ2Y1WFhDNWs0M2pcbkFWdjVpOGI0ZTRxMmFUbGpaYnJxa2s3YlBMOHlMTGIxcGo0TzJGeWh1MGZwQnQwd2Q1enJUVnpzU1dlYjZzMjFcbmh2NjdOUSt4UUlUelVMMElyaGNTbUtPVVRScXl2eEFYNFdDSUMwbjNjb05JVitSWUlPNEMwZFZKS3NPNE5IYnhcbnpMajNTR2grK2dJdTRRZFVraElUTmN1QlxuLS0tLS1FTkQgUFJJVkFURSBLRVktLS0tLVxuIiwKICAiY2xpZW50X2VtYWlsIjogIjU3MDU0MDEyNTI4My1jb21wdXRlQGRldmVsb3Blci5nc2VydmljZWFjY291bnQuY29tIiwKICAiY2xpZW50X2lkIjogIjExMDEzNjc2OTQ4NTI0Mjg1NDEwOCIsCiAgImF1dGhfdXJpIjogImh0dHBzOi8vYWNjb3VudHMuZ29vZ2xlLmNvbS9vL29hdXRoMi9hdXRoIiwKICAidG9rZW5fdXJpIjogImh0dHBzOi8vb2F1dGgyLmdvb2dsZWFwaXMuY29tL3Rva2VuIiwKICAiYXV0aF9wcm92aWRlcl94NTA5X2NlcnRfdXJsIjogImh0dHBzOi8vd3d3Lmdvb2dsZWFwaXMuY29tL29hdXRoMi92MS9jZXJ0cyIsCiAgImNsaWVudF94NTA5X2NlcnRfdXJsIjogImh0dHBzOi8vd3d3Lmdvb2dsZWFwaXMuY29tL3JvYm90L3YxL21ldGFkYXRhL3g1MDkvNTcwNTQwMTI1MjgzLWNvbXB1dGUlNDBkZXZlbG9wZXIuZ3NlcnZpY2VhY2NvdW50LmNvbSIKfQo=
kind: Secret
metadata:
  name: kaniko-secret
  namespace: default
type: Opaque
"""
    }
  }

  stages {
    stage('Run maven') {
      steps {
        container('maven') {
          sh 'ls -al'
          sh 'mvn clean package'
        }
        container('kaniko') {
          sh 'ls -al'
          sh 'pwd'
          sh 'executor --dockerfile=Dockerfile --context=dir://home/jenkins/agent/workspace/test1_spring-boot --destination=gcr.io/solar-botany-297306/gs-spring-boot-docker:v2'
        }        
      }
    }
  }
}
