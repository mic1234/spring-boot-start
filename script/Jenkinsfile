pipeline {
  agent {
    node {
      label 'builder'
    }
  }
  environment {
    pipi = 'kiki'
  }
  stages {
    stage('Run maven') {
      steps {
          sh 'ls -al'
          sh 'pwd'
          sh 'mvn clean package'
          sh 'ls -al'
          sh 'pwd'
          sh 'docker build . --tag=gcr.io/solar-botany-297306/gs-spring-boot-docker:v2 --no-cache'
          sh 'docker login -u _json_key -p "$(cat /secret/kaniko-secret.json)" http://gcr.io/'
          sh 'docker push gcr.io/solar-botany-297306/gs-spring-boot-docker:v2'
          sh 'gcloud auth activate-service-account 570540125283-compute@developer.gserviceaccount.com --key-file=/secret/kaniko-secret.json'
          sh 'gcloud container clusters get-credentials application-cluster --zone us-east4-b'
          sh 'kubectl get all'
          sh 'kubectl delete --ignore-not-found=true deployment spring-boot-start'
          sh 'kubectl delete --ignore-not-found=true service spring-boot-start'
          sh 'kubectl create deployment spring-boot-start --image gcr.io/solar-botany-297306/gs-spring-boot-docker@sha256:00ecfc56a25f2ab1a5da0227b7447c6d90c7a3d75e6555bc884712cfd15d2b07'
          sh 'kubectl expose deployment spring-boot-start --port 8080 --type LoadBalancer'
          sh 'helm init --debug --stable-repo-url https://charts.bitnami.com/bitnami'
          sh '''
              #!#/bin/bash
              #helm repo add bitnami https://charts.bitnami.com/bitnami
              helm repo update
              echo "{print \\\$1}" | tee temp1.txt
              val=$(helm list | sed -n "2 p" | awk -f temp1.txt)
              echo "val= $val"
              while [ ${#val} -gt 0 ]; do helm uninstall $val; val=$(helm list | sed -n "2 p" | awk -f temp1.txt ); done
              helm install my-sql bitnami/mysql --version 8.2.3
              '''
          sh 'chmod 755 ./script/print.sh'
          sh './script/print.sh'

          sh 'helmfile -v'

          sh 'echo "environment = ${environment}"'
          sh 'echo "location = ${location}"'
          sh 'echo "newvar = ${newvar}"'
          sh 'echo "dvar = ${dvar}"'
          sh 'echo "dvar1 = ${dvar1}"'
          sh 'echo "dvar2 = ${dvar2}"'
          sh 'echo "pipi = ${pipi}"'
          sh 'echo "hehe = ${hehe}"'
          sh 'echo "kaka = ${kaka}"'
          sh 'echo "koko = ${koko}"'

          echo "env.BUILD_URL = ${env.BUILD_URL}"
          echo "env.dvar = ${env.dvar}"
          echo "env.dvar1 = ${env.dvar1}"
          echo "env.dvar2 = ${env.dvar2}"
          echo "env.environment = ${env.environment}"
          echo "env.location = ${env.location}"
          echo "env.newvar = ${env.newvar}"
          echo "params.hehe = ${params.hehe}"
          echo "env.kaka = ${env.kaka}"
          echo "env.koko = ${env.koko}"
      }
    }
  }
}
